name: ðŸš€ è‡ªåŠ¨åŒ–éƒ¨ç½²

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    name: ðŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ðŸ” HTML éªŒè¯
        run: |
          echo "æ£€æŸ¥HTMLè¯­æ³•..."
          npx html-validate index.html || true

      - name: ðŸŽ¨ CSS æ£€æŸ¥
        run: |
          echo "æ£€æŸ¥CSSè¯­æ³•..."
          npx stylelint "**/*.css" || true

      - name: ðŸ“ JavaScript æ£€æŸ¥
        run: |
          echo "æ£€æŸ¥JavaScriptè¯­æ³•..."
          npx eslint script.js || true

  # æž„å»ºå’Œæµ‹è¯•
  build-test:
    name: ðŸ—ï¸ æž„å»ºå’Œæµ‹è¯•
    runs-on: ubuntu-latest
    needs: quality-check
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ðŸ—ï¸ æž„å»ºé¡¹ç›®
        run: |
          echo "æž„å»ºé¡¹ç›®..."
          mkdir -p dist
          cp -r *.html *.css *.js *.md dist/
          cp -r static dist/ 2>/dev/null || true

      - name: ðŸ“Š ç”Ÿæˆæž„å»ºæŠ¥å‘Š
        run: |
          echo "ç”Ÿæˆæž„å»ºæŠ¥å‘Š..."
          echo "## ðŸ“Š æž„å»ºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… HTMLæ–‡ä»¶: $(find dist -name '*.html' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CSSæ–‡ä»¶: $(find dist -name '*.css' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… JSæ–‡ä»¶: $(find dist -name '*.js' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ æž„å»ºå¤§å°: $(du -sh dist | cut -f1)" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  # éƒ¨ç½²åˆ° GitHub Pages
  deploy-github-pages:
    name: ðŸŒ éƒ¨ç½²åˆ° GitHub Pages
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: ðŸš€ éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v3

      - name: ðŸ“Š éƒ¨ç½²çŠ¶æ€
        run: |
          echo "## ðŸš€ éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ è®¿é—®åœ°å€: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- â° éƒ¨ç½²æ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY

  # éƒ¨ç½²åˆ° Vercel
  deploy-vercel:
    name: âš¡ éƒ¨ç½²åˆ° Vercel
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ å®‰è£… Vercel CLI
        run: npm install -g vercel

      - name: âš¡ éƒ¨ç½²åˆ° Vercel
        run: vercel --prod --token ${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  # éƒ¨ç½²åˆ° Netlify
  deploy-netlify:
    name: ðŸŒŸ éƒ¨ç½²åˆ° Netlify
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: ðŸŒŸ éƒ¨ç½²åˆ° Netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './dist'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "ðŸš€ è‡ªåŠ¨éƒ¨ç½² - ${{ github.sha }}"
          enable-pull-request-comment: true
          enable-commit-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  # é€šçŸ¥éƒ¨ç½²ç»“æžœ
  notify:
    name: ðŸ“¢ é€šçŸ¥éƒ¨ç½²ç»“æžœ
    runs-on: ubuntu-latest
    needs: [deploy-github-pages, deploy-vercel, deploy-netlify]
    if: always()
    steps:
      - name: ðŸ“¢ å‘é€é€šçŸ¥
        run: |
          echo "## ðŸ“¢ éƒ¨ç½²é€šçŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ‰ æ‰€æœ‰éƒ¨ç½²ä»»åŠ¡å·²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“… æ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— æäº¤: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
